<!DOCTYPE html>
<html>
<!--
Copyright © 2018 Jakub Wilk <jwilk@jwilk.net>
SPDX-License-Identifier: MIT
-->
<meta charset="UTF-8">
<title>ChemiScripts — translate ASCII chemical formulas to Unicode</title>
<body>
<noscript><div>Please enable JavaScript to use this site.</div></noscript>
<form action="" method="GET">
<input name="q" id="query">
</form>
<div id="out">
</div>
<script>

"use strict";

function ord(s)
{
    return s.codePointAt();
}

function chr(i)
{
    return String.fromCodePoint(i);
}

function Script(s)
{
    this["+"] = s[0];
    this["-"] = s[1];
    for (let i = 0; i < 10; i++) {
        let c = chr(ord("0") + i)
        this[c] = s[2 + i];
    }
}

Script.prototype.translate = function(s) {
    var script = this;
    var trans_char = function(c) {
        let t = script[c];
        if (t === undefined)
            t = c;
        return t;
    }
    return s.replace(/./g, trans_char);
}

var sup = new Script("⁺⁻⁰¹²³⁴⁵⁶⁷⁸⁹");
var sub = new Script("₊₋₀₁₂₃₄₅₆₇₈₉");
var arrows = {
    "->": "→",
    "=": "⇌",
};

var _regexp = [
    /([\]\)A-Za-z])([0-9]*)([+-]?)/,
    /(\s+)([0-9]+[+-])/,
    /(->|=)/
];
_regexp = _regexp.map(function(re) { return re.source }).join("|");
_regexp = new RegExp(_regexp, "g");

function translate(formula)
{
    var translate_one = function(match, g1, g1a, g1b, g2, g2a, g3)
    {
        if (g1 !== undefined)
            return g1 + sub.translate(g1a) + sup.translate(g1b);
        if (g2 !== undefined)
            return sup.translate(g2a);
        if (g3 !== undefined)
            return arrows[g3];
    }
    return formula.replace(_regexp, translate_one);
}

var query = window.location.search.substring(1);
var formula;
query = query.split("&");
for (let s of query) {
    s = s.split("=", 2);
    if (s[0] === "q") {
        formula = decodeURIComponent(s[1].replace(/[+]/g, " "));
        break;
    }
}
var elt = document.getElementById("query");
elt.value = formula;
elt = document.getElementById("out");
elt.textContent = translate(formula);

</script>
</body>
</html>

<!-- vim:set ts=4 sts=4 sw=4 et:-->
